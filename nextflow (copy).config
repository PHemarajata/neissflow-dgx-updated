// Manifest

manifest {
    name = 'neissflow/main.nf'
    description = 'neissflow'
    version = '2.0.0'
    author = 'Kat Morin'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.10.0'
    doi             = ''
}

params {

  // Config options
  config_profile_name        = null
  config_profile_description = null
  config_profile_contact     = 'xqc3@cdc.gov'
  config_profile_url         = null
  
  // Working directory and asset paths
  assets_dir                 = "/home/phemarajata/neissflow/assets"
  
  // Disk space management
  min_disk_space             = 20  // Minimum disk space in GB required for assembly
  
  // set defaults - now using configurable assets_dir
  mash_db                    = "${params.assets_dir}/databases/RefSeqSketchesDefaults.msh" 
  reference_genome           = null
  FA19_ref                   = "${params.assets_dir}/FA19.gb"
  FA19cg                     = "${params.assets_dir}/FA19cg.fa"
  amr_ref                    = "${params.assets_dir}/amr_genes.gbk"
  loci                       = "${params.assets_dir}/FA19_loci.tsv"
  penAdb                     = "${params.assets_dir}/blastdb/penAdb"   
  porBdb                     = "${params.assets_dir}/blastdb/porBdb"
  mtrR_mosaic_ref            = "${params.assets_dir}/gene_refs/mosaic-mtrR.fasta"
  default_amr                = "${params.assets_dir}/AMR_defaults.tsv"
  columns                    = "${params.assets_dir}/amr_columns.txt"
  ngmasterdb                 = "${params.assets_dir}/alleledb/ngmaster/"
  ngstar                     = "${params.assets_dir}/alleledb/ngmaster/pubmlst/ngstar/ngstar.txt"
  ngmast                     = "${params.assets_dir}/alleledb/ngmaster/pubmlst/ngmast/ngmast.txt"
  pubmlst                    = "${params.assets_dir}/databases/pubmlst"
  blastdb                    = "${params.assets_dir}/databases/blastdb/mlst.fa"
  ngmasterdb_version         = "01/2025"
  snp_dist                   = 20
  depth                      = 150
  max_itr                    = 25
  controls                   = null
  QC                         = false
  name                       = "complete"

  // MultiQC options
  multiqc_config             = null
  multiqc_title              = null
  multiqc_logo               = null
  max_multiqc_email_size     = '25.MB'
  multiqc_methods_description = null

  //Boilerplate options
  help                         = false
  input                        = null
  outdir                       = null
  publish_dir_mode             = 'copy'
  version                      = 2.0
  monochrome_logs              = false
  monochromeLogs               = false
  email                        = null
  email_on_fail                = null
  plaintext_email              = false
  hook_url                     = null

  //Other
  only_fastq                   = false
  only_fasta                   = false
  fastq_w_fasta                = false
  skip_fastq_check             = false
  skip_preprocess              = false
  skip_assembly                = false
  skip_assembly_qc             = false
  skip_species_id              = false
  skip_amr                     = false
  skip_phylogeny               = false
  remove_ref                   = false
  use_lite_assembly_stats      = false
  use_simple_ngmaster          = false
  validate_params              = false
  validationSkipDuplicateCheck = true
  validationS3PathCheck        = false
  downsample                   = false


  
  // Max resource options
  max_memory                 = '256.GB'
  max_cpus                   = 16
  max_time                   = '240.h'
}

// Load base.config by default for all pipelines
includeConfig 'conf/base.config'

// Global environment variables to prevent Numba caching issues in containers
env {
    NUMBA_CACHE_DIR = '/tmp'
    NUMBA_DISABLE_JIT = '0'
    NUMBA_DISABLE_CACHING = '1'
    NUMBA_DISABLE_INTEL_SVML = '1'
    NUMBA_DISABLE_HSA = '1'
    NUMBA_DISABLE_CUDA = '1'
}

/*
========================================================================================
    Nextflow Metrics & Reports
========================================================================================
*/

timeline {
  enabled = true
  file    = "${params.outdir}/timeline.html"
}

report {
  enabled = true
  file    = "${params.outdir}/report.html"
}

trace {
  enabled = true
  fields  = 'task_id,name,status,exit,realtime,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar'
  file    = "${params.outdir}/trace.txt"
}

/*
========================================================================================
    Base Executor config
========================================================================================
*/

executor {
  queueSize = 2
}

/*
========================================================================================
    Profiles - all,short,gpu,highmem,singularity,test,test_both,test_fasta,QC,dgx_a100
========================================================================================
*/

profiles {

  all {
    process {
      executor     = 'sge'
      penv         = 'smp'
      queue        = 'all.q'
    }
    executor {
      queueSize    = 12
      pollInterval = '15 sec'
    }
  }
  short {
    process {
      executor     = 'sge'
      penv         = 'smp'
      queue        = 'short.q'
    }
    executor {
      queueSize    = 12
      pollInterval = '15 sec'
    }
  }

  highmem {
    process {
      executor     = 'sge'
      penv         = 'smp'
      queue        = 'highmem.q'
    }
    executor {
      queueSize    = 12
      pollInterval = '15 sec'
    }
  }

  singularity {
    includeConfig 'conf/singularity.config'
  }

  test {
    includeConfig 'conf/test.config'
  }

  test_both {
    includeConfig 'conf/test_both.config'
  }

  test_fasta {
    includeConfig 'conf/test_fasta.config'
  }

  QC {
    includeConfig 'conf/QC.config'
  }

  dgx_a100 {
    params {
      max_memory = '400.GB'
      max_cpus   = 100
      max_time   = '240.h'
      config_profile_name        = 'NVIDIA DGX Station A100'
      config_profile_description = 'Profile optimized for NVIDIA DGX Station A100 with 128 cores and 504GB RAM'
    }
    process {
      executor = 'local'
      
      // Adjusted resource allocations for DGX A100
      cpus   = { check_max( 2    * task.attempt, 'cpus'   ) }
      memory = { check_max( 16.GB * task.attempt, 'memory' ) }
      time   = { check_max( 4.h  * task.attempt, 'time'   ) }

      // Process-specific resource requirements scaled for DGX A100
      withLabel:process_single {
        cpus   = { check_max( 2                  , 'cpus'    ) }
        memory = { check_max( 24.GB * task.attempt, 'memory' ) }
        time   = { check_max( 2.h  * task.attempt, 'time'    ) }
      }
      withLabel:process_low {
        cpus   = { check_max( 8      * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 2.h    * task.attempt, 'time'   ) }
      }
      withLabel:process_medium {
        cpus   = 24
        memory = { check_max( 64.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 4.h    * task.attempt, 'time'   ) }
      }
      withLabel:process_high {
        cpus   = 48
        memory = { check_max( 128.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h   * task.attempt, 'time'   ) }
      }
      withLabel:process_assembly {
        cpus   = 64
        memory = { check_max( 256.GB * task.attempt, 'memory' ) }
        time   = { check_max( 12.h  * task.attempt, 'time'   ) }
      }
      withLabel:process_multi {
        cpus   = { check_max( 32   * task.attempt, 'cpus'   ) }
      }
      withLabel:process_long {
        time   = { check_max( 48.h   * task.attempt, 'time'   ) }
      }
      withLabel:process_low_memory {
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
      }
      withLabel:process_medium_memory {
        memory = { check_max( 128.GB * task.attempt, 'memory' ) }
      }
      withLabel:process_high_memory {
        memory = { check_max( 256.GB * task.attempt, 'memory' ) }
      }
    }
    executor {
      queueSize = 20
      pollInterval = '5 sec'
    }
  }

  debug {
    dumpHashes              = true
    process.beforeScript    = 'echo $HOSTNAME'
    cleanup                 = false
    nextflow.enable.configProcessNamesValidation = true
  }
}

// Load modules.config for DSL2 module specific options
includeConfig 'conf/modules.config'

// Function to ensure that resource requirements don't go beyond
// a maximum limit

def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}
